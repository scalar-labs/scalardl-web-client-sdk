/* eslint-disable no-invalid-this */
const {
  ClientServiceBase,
  StatusCode,
  ClientProperties,
} = require('@scalar-labs/scalardl-javascript-sdk-base');

const protobuf = require('./scalar_pb');
const {
  LedgerClient,
  LedgerPrivilegedClient,
  AuditorClient,
  AuditorPrivilegedClient,
} = require('./scalar_grpc_web_pb');

const {SignerFactory} = require('./signer');
const {
  ClientServiceWithIndexedDb,
  IndexedDbKeyNotFoundError,
  IndexedDbOperationError,
} = require('./indexdb');

/**
 * This class inherits ClientServiceBase.
 * It needs to be constructed with LedgerClient
 * and protobuf messages that are generated by gRPC tools
 * @class
 */
class ClientService extends ClientServiceBase {
  /**
   * Inject LedgerClient and protobuf messages
   * @constructor
   * @param {Object} properties JSON Object used for setting client properties
   */
  constructor(properties) {
    const clientProperties = new ClientProperties(properties);

    const host = clientProperties.getServerHost();
    const auditorHost = clientProperties.getAuditorHost();
    const tlsEnabled = clientProperties.getTlsEnabled();
    const ledgerClientServiceURL =
      `${tlsEnabled ? 'https' : 'http'}://${host}:${clientProperties.getServerPort()}`;
    const ledgerPriviledgedClientServiceURL =
      `${tlsEnabled ? 'https' : 'http'}://${host}:${clientProperties.getServerPrivilegedPort()}`;
    const auditorClientServiceURL =
      `${tlsEnabled ? 'https' : 'http'}://${auditorHost}:${clientProperties.getAuditorPort()}`;
    const auditorPriviledgedClientServiceURL =
      `${tlsEnabled ? 'https' : 'http'}://${auditorHost}:${clientProperties.getAuditorPrivilegedPort()}`;

    const services = {
      ledgerClient: new LedgerClient(ledgerClientServiceURL),
      ledgerPrivileged: new LedgerPrivilegedClient(ledgerPriviledgedClientServiceURL),
      auditorClient: new AuditorClient(auditorClientServiceURL),
      auditorPrivileged: new AuditorPrivilegedClient(auditorPriviledgedClientServiceURL),
      signerFactory: new SignerFactory(),
    };

    const metadata = {};
    if (clientProperties.getAuthorizationCredential()) {
      metadata.Authorization =
          clientProperties.getAuthorizationCredential();
    }
    super(services, protobuf, properties, metadata);
  }
}

module.exports = {
  ClientService,
  ClientServiceWithIndexedDb,
  IndexedDbKeyNotFoundError,
  IndexedDbOperationError,
  StatusCode,
};
